{% extends 'base.html' %}
{% block title %}Scanner de Presença - {{ evento.titulo }}{% endblock %}

{% block content %}
<div class="container text-center mt-4">
  <h3>Evento Ativo: {{ evento.titulo }}</h3>
  <p>Aponte a câmera para o QR Code da carteirinha do membro para registrar a presença.</p>

  <div id="qr-reader" style="width: 300px; margin: 0 auto;"></div>
  <div id="qr-result" class="mt-3 fw-bold"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const qrResult = document.getElementById('qr-result');

  function onScanSuccess(decodedText, decodedResult) {
    qrResult.textContent = `QR Code detectado! Registrando presença...`;

    fetch(decodedText, {
      method: 'GET',
      credentials: 'same-origin'
    })
    .then(response => response.text())
    .then(data => {
      qrResult.textContent = data;
    })
    .catch(err => {
      qrResult.textContent = "Erro ao registrar presença.";
      console.error(err);
    });

    html5QrcodeScanner.clear();
    setTimeout(() => {
      qrResult.textContent = "";
      html5QrcodeScanner.render(onScanSuccess);
    }, 3000);
  }

  var html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
  html5QrcodeScanner.render(onScanSuccess);
</script>
{% endblock %}
